<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Quran Ruku Viewer</title>
    <link rel="stylesheet" href="dark.css">
</head>
<body>

<div id="sidebar">

    <select id="jumpSelect">
        <option value="">Перейти к...</option>
    </select>

    <select id="tagFilter">
        <option value="">Все теги</option>
    </select>

    <div id="rukuList"></div>
</div>

<div id="content">
    <h2>Выберите руку‘</h2>
</div>

<script>
/* ================== ДАННЫЕ ================== */

const sidebarItems = [
    { type: "juz", number: 1 },
    { type: "surah", number: 1, name: "Аль-Фатиха" },
    { type: "ruku", id: 1, title: "Наилучшая молитва", tags: ["Молитвы"], chapter: 1, from: 1, to: 7, juz: 1 },
    
    { type: "surah", number: 1, name: "Аль-Бакара" },
    { type: "ruku", id: 2, title: "1 [1:7]. Это руководство для богобоязненных", tags: ["Неверующие", "Коран"], chapter: 2, from: 1, to: 7, juz: 1, sections: [], boldSeparators: [5] },
    { type: "ruku", id: 3, title: "2 [8:20]. Лицемеры и последствия лицемерия", tags: [], chapter: 2, from: 8, to: 20, juz: 1, boldSeparators: [16] },
    { type: "ruku", id: 4, title: "3 [21:29]. Требование ﷲ поклонятся исключительно Ему", tags: [], chapter: 2, from: 21, to: 29, juz: 1, boldSeparators: [22, 24, 25, 27]},
    { type: "ruku", id: 5, title: "4 [30:37]. История создания Адама ﵇", tags: [], chapter: 2, from: 30, to: 37, juz: 1, boldSeparators: [30, 33, 35, 36, 37] },
    { type: "ruku", id: 6, title: "5 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 7, title: "6 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 8, title: "7 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 9, title: "8 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 10, title: "9 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 11, title: "10 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 12, title: "11 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 13, title: "12 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 14, title: "13 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 15, title: "14 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 16, title: "15 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 17, title: "16 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 18, title: "17 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 19, title: "18 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 20, title: "19 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 21, title: "20 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 22, title: "21 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 23, title: "22 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 24, title: "23 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 25, title: "24 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 26, title: "25 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 27, title: "26 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 28, title: "27 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 29, title: "28 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 30, title: "29 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 31, title: "30 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 32, title: "31 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 33, title: "32 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 34, title: "33 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 35, title: "34 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 36, title: "35 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 37, title: "36 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 38, title: "37 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 39, title: "38 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 40, title: "39 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
    { type: "ruku", id: 41, title: "40 [:]", tags: [], chapter: 2, from: 1, to: 7, juz: 1, boldSeparators: []  },
];

/* ================== СОСТОЯНИЕ ================== */

const rukuList = document.getElementById("rukuList");
const tagFilter = document.getElementById("tagFilter");
const jumpSelect = document.getElementById("jumpSelect");
const content = document.getElementById("content");

let activeRukuId = null;
let activeJuz = null;
let bookmarks = JSON.parse(localStorage.getItem("bookmarks")) || [];
let expandedRukuId = null;
    
/* ================== ТЕГИ ================== */

const tags = [...new Set(
    sidebarItems
        .filter(i => i.type === "ruku")
        .flatMap(r => r.tags)
)];

tags.forEach(tag => {
    const opt = document.createElement("option");
    opt.value = tag;
    opt.textContent = tag;
    tagFilter.appendChild(opt);
});

/* ================== ПЕРЕХОД ================== */

sidebarItems.forEach(item => {
    if (item.type === "juz") {
        const opt = document.createElement("option");
        opt.value = `juz-${item.number}`;
        opt.textContent = `Джуз ${item.number}`;
        jumpSelect.appendChild(opt);
    }
    if (item.type === "surah") {
        const opt = document.createElement("option");
        opt.value = `surah-${item.number}`;
        opt.textContent = `Сура ${item.number}. ${item.name}`;
        jumpSelect.appendChild(opt);
    }
});

jumpSelect.onchange = () => {
    const target = document.querySelector(
        `[data-anchor="${jumpSelect.value}"]`
    );
    if (target) {
        target.scrollIntoView({ behavior: "smooth" });
    }
};

function scrollToAyah(verseNumber) {
    const el = document.getElementById(`ayah-${verseNumber}`);
    if (el) {
        el.scrollIntoView({
            behavior: "smooth",
            block: "start"
        });

        el.classList.add("highlight");
        setTimeout(() => el.classList.remove("highlight"), 1200);
    }
}

/* ================== РЕНДЕР ================== */

function renderRukuList(filterTag = "") {
    rukuList.innerHTML = "";

    sidebarItems.forEach(item => {

        if ((item.type === "juz" || item.type === "surah") && filterTag) return;

        if (item.type === "juz") {
            const div = document.createElement("div");
            div.className = "divider juz";
            if (item.number === activeJuz) div.classList.add("active");
            div.textContent = `Джуз ${item.number}`;
            div.dataset.anchor = `juz-${item.number}`;
            rukuList.appendChild(div);
            return;
        }

        if (item.type === "surah") {
            const div = document.createElement("div");
            div.className = "divider surah";
            div.textContent = `Сура ${item.number}. ${item.name}`;
            div.dataset.anchor = `surah-${item.number}`;
            rukuList.appendChild(div);
            return;
        }

        if (item.type === "ruku") {
            if (filterTag && !item.tags.includes(filterTag)) return;

            const div = document.createElement("div");
            div.className = "ruku";
            if (item.id === activeRukuId) div.classList.add("active");

            const star = bookmarks.includes(item.id) ? "★ " : "";

            if (expandedRukuId === item.id && item.sections) {
                div.classList.add("active");
                div.innerHTML = `
                    <div class="ruku-sections">
                        ${item.sections.map(s => `
                            <div class="section"
                                 data-from="${s.from}">
                                ${s.title}
                            </div>
                        `).join("")}
                    </div>
                `;
            
                div.querySelectorAll(".section").forEach(sec => {
                    sec.onclick = (e) => {
                        e.stopPropagation();
            
                        if (activeRukuId !== item.id) {
                            loadRuku(item, sec.dataset.from);
                        } else {
                            scrollToAyah(sec.dataset.from);
                        }
                    };
                });
            
            } else {
                div.innerHTML = `
                    <strong>${star}${item.title}</strong>
                    <div class="tags">#${item.tags.join(" #")}</div>
                `;
            
                div.onclick = () => {
                    expandedRukuId = expandedRukuId === item.id ? null : item.id;
                    renderRukuList(tagFilter.value);
                    loadRuku(item);
                };
            }
            rukuList.appendChild(div);
        }
    });
}

tagFilter.onchange = () => renderRukuList(tagFilter.value);

/* ================== ЗАГРУЗКА РУКУ‘ ================== */

async function loadRuku(ruku) {
    activeRukuId = ruku.id;
    activeJuz = ruku.juz;
    renderRukuList(tagFilter.value);

    const isBookmarked = bookmarks.includes(ruku.id);

    content.innerHTML = `
        <h2>
            ${ruku.title}
            <button id="bookmarkBtn">${isBookmarked ? "★" : "☆"}</button>
        </h2>
    `;

    document.getElementById("bookmarkBtn").onclick = () => {
        if (isBookmarked) {
            bookmarks = bookmarks.filter(id => id !== ruku.id);
        } else {
            bookmarks.push(ruku.id);
        }
        localStorage.setItem("bookmarks", JSON.stringify(bookmarks));
        loadRuku(ruku);
    };

    const url = `https://api.quran.com/api/v4/verses/by_chapter/${ruku.chapter}?from=${ruku.from}&to=${ruku.to}&translations=45&fields=text_uthmani&per_page=50`

    const response = await fetch(url);
    const data = await response.json();

    data.verses.forEach(v => {
        const div = document.createElement("div");
        div.className = "ayah";
        div.id = `ayah-${v.verse_number}`;
    
        // если после этого аята нужен жирный разделитель
        if (ruku.boldSeparators && ruku.boldSeparators.includes(v.verse_number)) {
            div.classList.add("bold-border");
        }
    
        div.innerHTML = `
            <div class="translation">${v.translations[0].text}</div>
            <div class="arabic">${v.text_uthmani}</div>
        `;
    
        content.appendChild(div);
    });

}

renderRukuList();
</script>

</body>
</html>
