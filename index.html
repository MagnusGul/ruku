import { useEffect, useState, useMemo } from "react";

// Простое демо-приложение
// Источник данных: https://api.quran.com
// Теги и заголовки руку' хранятся локально (в state)

export default function QuranRukuViewer() {
  const [rukus, setRukus] = useState([]);
  const [selectedRuku, setSelectedRuku] = useState(null);
  const [verses, setVerses] = useState([]);
  const [translation, setTranslation] = useState([]);
  const [tagFilter, setTagFilter] = useState("all");

  // Загрузка списка руку'
  useEffect(() => {
    fetch("https://api.quran.com/api/v4/rukus")
      .then((res) => res.json())
      .then((data) => {
        // добавляем теги и заголовок локально
        const enriched = data.rukus.map((r) => ({
          ...r,
          title: `Руку ${r.ruku_number}`,
          tags: [] // пример: ['акыда', 'намаз']
        }));
        setRukus(enriched);
      });
  }, []);

  // Загрузка текста выбранного руку'
  useEffect(() => {
    if (!selectedRuku) return;

    fetch(
      `https://api.quran.com/api/v4/verses/by_ruku/${selectedRuku.ruku_number}?language=ru&words=false&translations=20`
    )
      .then((res) => res.json())
      .then((data) => {
        setVerses(data.verses);
        setTranslation(data.verses.map((v) => v.translations[0]));
      });
  }, [selectedRuku]);

  const allTags = useMemo(() => {
    const tags = new Set();
    rukus.forEach((r) => r.tags.forEach((t) => tags.add(t)));
    return ["all", ...Array.from(tags)];
  }, [rukus]);

  const filteredRukus = useMemo(() => {
    if (tagFilter === "all") return rukus;
    return rukus.filter((r) => r.tags.includes(tagFilter));
  }, [rukus, tagFilter]);

  return (
    <div className="flex h-screen text-sm">
      {/* Левая панель */}
      <aside className="w-1/4 border-r overflow-y-auto p-3 space-y-2">
        <h2 className="text-lg font-semibold">Руку'</h2>

        <select
          className="w-full border rounded p-1"
          value={tagFilter}
          onChange={(e) => setTagFilter(e.target.value)}
        >
          {allTags.map((t) => (
            <option key={t} value={t}>{t}</option>
          ))}
        </select>

        {filteredRukus.map((r) => (
          <button
            key={r.id}
            onClick={() => setSelectedRuku(r)}
            className={`block w-full text-left p-2 rounded hover:bg-gray-100 ${
              selectedRuku?.id === r.id ? "bg-gray-200" : ""
            }`}
          >
            <div className="font-medium">{r.title}</div>
            {r.tags.length > 0 && (
              <div className="text-xs text-gray-500">{r.tags.join(", ")}</div>
            )}
          </button>
        ))}
      </aside>

      {/* Правая часть */}
      <main className="flex-1 overflow-y-auto p-6">
        {!selectedRuku && (
          <div className="text-gray-500">Выберите руку слева</div>
        )}

        {selectedRuku && (
          <div className="space-y-4">
            <h1 className="text-xl font-semibold">{selectedRuku.title}</h1>

            {verses.map((v, i) => (
              <div
                key={v.id}
                className="grid grid-cols-2 gap-6 border-b pb-4"
              >
                <div className="text-gray-800 leading-relaxed">
                  {translation[i]?.text}
                </div>
                <div className="text-right text-lg leading-loose font-arabic">
                  {v.text_uthmani}
                </div>
              </div>
            ))}
          </div>
        )}
      </main>
    </div>
  );
}
